<div class="page-container">
  <div class="page-header">
    <button class="btn-back" routerLink="/quality" title="Back to Quality Dashboard">
      <span class="material-icons">arrow_back</span>
    </button>
    <h1><span class="material-icons">notifications</span> Alert Rules</h1>
    <button class="btn-primary" (click)="openCreateModal()">
      <span class="material-icons">add</span>
      Create Rule
    </button>
  </div>

  <div class="error-message" *ngIf="error">
    <span class="material-icons">error</span>
    {{ error }}
    <button class="btn-close" (click)="error = null">
      <span class="material-icons">close</span>
    </button>
  </div>

  <div class="loading-spinner" *ngIf="loading && alertRules.length === 0">
    <div class="spinner"></div>
    <p>Loading alert rules...</p>
  </div>

  <div class="empty-state" *ngIf="!loading && alertRules.length === 0">
    <span class="material-icons">notifications_none</span>
    <h2>No Alert Rules Configured</h2>
    <p>Create your first alert rule to monitor quality metrics and receive notifications.</p>
    <button class="btn-primary" (click)="openCreateModal()">
      <span class="material-icons">add</span>
      Create Alert Rule
    </button>
  </div>

  <div class="rules-grid" *ngIf="!loading && alertRules.length > 0">
    <div class="rule-card" *ngFor="let rule of alertRules" [class.disabled]="!rule.enabled">
      <div class="rule-header">
        <div class="rule-title">
          <h3>{{ rule.name }}</h3>
          <span class="rule-type-badge">{{ getRuleTypeLabel(rule.rule_type) }}</span>
        </div>
        <div class="rule-status">
          <label class="toggle-switch">
            <input type="checkbox" [checked]="rule.enabled" (change)="toggleRule(rule)">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <p class="rule-description" *ngIf="rule.description">{{ rule.description }}</p>

      <div class="rule-details">
        <div class="detail-item">
          <span class="label">Threshold:</span>
          <span class="value">{{ rule.threshold_value }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Check Interval:</span>
          <span class="value">{{ rule.check_interval_hours }}h</span>
        </div>
        <div class="detail-item">
          <span class="label">Min Samples:</span>
          <span class="value">{{ rule.min_sample_size }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Throttle:</span>
          <span class="value">{{ rule.throttle_minutes }}m</span>
        </div>
      </div>

      <div class="notification-channels">
        <span class="label">Channels:</span>
        <div class="channels-list">
          <span class="channel-badge" *ngFor="let channel of rule.notification_channels">
            <span class="material-icons">{{ channel === 'email' ? 'email' : channel === 'webhook' ? 'webhook' : 'terminal' }}</span>
            {{ channel }}
          </span>
        </div>
      </div>

      <div class="rule-footer">
        <div class="rule-meta">
          <span class="meta-item" *ngIf="rule.last_triggered_at">
            <span class="material-icons">schedule</span>
            Last triggered: {{ formatDate(rule.last_triggered_at) }}
          </span>
          <span class="meta-item">
            <span class="material-icons">update</span>
            Updated: {{ formatDate(rule.updated_at) }}
          </span>
        </div>
        <div class="rule-actions">
          <button class="btn-action" (click)="testRule(rule)" title="Test Alert">
            <span class="material-icons">play_arrow</span>
          </button>
          <button class="btn-action" (click)="openEditModal(rule)" title="Edit">
            <span class="material-icons">edit</span>
          </button>
          <button class="btn-action btn-danger" (click)="deleteRule(rule)" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editMode ? 'Edit Alert Rule' : 'Create Alert Rule' }}</h2>
      <button class="btn-close" (click)="closeModal()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Rule Name <span class="required">*</span></label>
        <input type="text" [(ngModel)]="formData.name" placeholder="Enter rule name" class="form-control">
      </div>

      <div class="form-group">
        <label>Rule Type <span class="required">*</span></label>
        <select [(ngModel)]="formData.rule_type" class="form-control" [disabled]="editMode">
          <option *ngFor="let type of ruleTypes" [value]="type.value">
            {{ type.label }} - {{ type.description }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="formData.description" placeholder="Optional description" class="form-control" rows="3"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Threshold Value <span class="required">*</span></label>
          <input type="number" [(ngModel)]="formData.threshold_value" step="0.01" min="0" max="1" class="form-control">
        </div>

        <div class="form-group">
          <label>Check Interval (hours) <span class="required">*</span></label>
          <input type="number" [(ngModel)]="formData.check_interval_hours" min="1" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Min Sample Size <span class="required">*</span></label>
          <input type="number" [(ngModel)]="formData.min_sample_size" min="1" class="form-control">
        </div>

        <div class="form-group">
          <label>Throttle (minutes) <span class="required">*</span></label>
          <input type="number" [(ngModel)]="formData.throttle_minutes" min="0" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label>Notification Channels <span class="required">*</span></label>
        <div class="checkbox-group">
          <label class="checkbox-label" *ngFor="let channel of channels">
            <input type="checkbox" [checked]="isChannelSelected(channel.value)" (change)="toggleChannel(channel.value)">
            <span>{{ channel.label }}</span>
          </label>
        </div>
      </div>

      <div class="form-group" *ngIf="isChannelSelected('email')">
        <label>Email Recipients (comma-separated)</label>
        <input type="text" [(ngModel)]="formData.email_recipients" placeholder="email1@example.com, email2@example.com" class="form-control">
      </div>

      <div class="form-group" *ngIf="isChannelSelected('webhook')">
        <label>Webhook URLs (comma-separated)</label>
        <input type="text" [(ngModel)]="formData.webhook_urls" placeholder="https://webhook1.com, https://webhook2.com" class="form-control">
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="formData.enabled">
          <span>Enable Rule</span>
        </label>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">Cancel</button>
      <button class="btn-primary" (click)="saveRule()" [disabled]="loading">
        {{ loading ? 'Saving...' : (editMode ? 'Update Rule' : 'Create Rule') }}
      </button>
    </div>
  </div>
</div>
