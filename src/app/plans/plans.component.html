<div class="plans-container">
  <header class="plans-header">
    <button (click)="goBack()" class="back-button">
      <span class="material-icons">arrow_back</span>
      Back to Dashboard
    </button>
    <h1>Subscription Plans</h1>
    <p class="subtitle">Choose the perfect plan for your needs</p>
  </header>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading plans...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <span class="material-icons">error</span>
    <p>{{ error }}</p>
    <button (click)="loadPlansData()" class="retry-button">Retry</button>
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="success-message">
    <span class="material-icons">check_circle</span>
    {{ successMessage }}
  </div>

  <!-- Plans Content -->
  <div *ngIf="!loading && !error" class="plans-content">
    <!-- Current Plan Info -->
    <div *ngIf="currentPlan" class="current-plan-info">
      <h2>Current Plan</h2>
      <div class="current-plan-card">
        <h3>{{ currentPlan.name }}</h3>
        <p>{{ currentPlan.description }}</p>
        <div class="current-plan-details">
          <span *ngIf="!isPricingCall(currentPlan)">₦{{ formatNumber(getPlanCost(currentPlan)) }}/{{ billingCycle }}</span>
          <span *ngIf="isPricingCall(currentPlan)" class="call-pricing">Call for Pricing</span>
          <span class="plan-limits">
            {{ formatLimit(currentPlan.document_limit) }} docs •
            {{ formatLimit(currentPlan.website_limit) }} sites •
            {{ formatLimit(currentPlan.daily_chat_limit) }} daily chats
          </span>
        </div>

        <!-- Subscription Expiry Information -->
        <div *ngIf="currentSubscription && currentSubscription.current_period_end" class="subscription-expiry">
          <div class="expiry-info" [ngClass]="{
            'expiry-warning': isExpiringSoon(),
            'expiry-danger': hasExpired()
          }">
            <span class="material-icons">
              {{ hasExpired() ? 'error' : isExpiringSoon() ? 'warning' : 'event' }}
            </span>
            <div class="expiry-details">
              <span class="expiry-label">
                {{ hasExpired() ? 'Expired on' : currentSubscription.cancel_at_period_end ? 'Cancels on' : 'Renews on' }}
              </span>
              <span class="expiry-date">{{ formatExpiryDate(currentSubscription.current_period_end) }}</span>
              <span class="expiry-countdown" *ngIf="!hasExpired()">
                ({{ getDaysUntilExpiry() }} {{ getDaysUntilExpiry() === 1 ? 'day' : 'days' }} remaining)
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Billing Cycle Toggle -->
    <div class="billing-toggle">
      <label>Billing Cycle:</label>
      <div class="toggle-buttons">
        <button 
          [class.active]="billingCycle === 'monthly'"
          (click)="setBillingCycle('monthly')"
          class="toggle-button">
          Monthly
        </button>
        <button 
          [class.active]="billingCycle === 'yearly'"
          (click)="setBillingCycle('yearly')"
          class="toggle-button">
          Yearly <span class="savings">Save 17%</span>
        </button>
      </div>
    </div>

    <!-- Plans Grid -->
    <div class="plans-grid">
      <div 
        *ngFor="let plan of plans" 
        class="plan-card"
        [class.current]="isCurrentPlan(plan)"
        [class.upgrade]="isUpgrade(plan)"
        [class.downgrade]="isDowngrade(plan)">
        
        <div class="plan-header">
          <h3>{{ plan.name }}</h3>
          <div class="plan-badge" *ngIf="isCurrentPlan(plan)">Current Plan</div>
          <div class="plan-badge upgrade-badge" *ngIf="isUpgrade(plan) && !isCurrentPlan(plan)">Upgrade</div>
          <div class="plan-badge downgrade-badge" *ngIf="isDowngrade(plan)">Downgrade</div>
        </div>

        <div class="plan-price">
          <span class="currency">₦</span>
          <span class="amount">{{ getPlanCostDisplay(plan) }}</span>
          <span class="period" *ngIf="!isPricingCall(plan)">/{{ billingCycle }}</span>
        </div>

        <p class="plan-description">{{ plan.description }}</p>

        <div class="plan-limits">
          <div class="limit-item">
            <span class="material-icons">description</span>
            <span>{{ formatLimit(plan.document_limit) }} documents</span>
          </div>
          <div class="limit-item">
            <span class="material-icons">language</span>
            <span>{{ formatLimit(plan.website_limit) }} websites</span>
          </div>
          <div class="limit-item">
            <span class="material-icons">chat</span>
            <span>{{ formatLimit(plan.daily_chat_limit) }} daily chats</span>
          </div>
          <div class="limit-item">
            <span class="material-icons">chat_bubble_outline</span>
            <span>{{ formatLimit(plan.monthly_chat_limit) }} monthly chats</span>
          </div>
        </div>

        <div class="plan-features" *ngIf="getFeaturesList(plan).length > 0">
          <h4>Features</h4>
          <ul>
            <li *ngFor="let feature of getFeaturesList(plan)">
              <span class="material-icons">check</span>
              {{ feature }}
            </li>
          </ul>
        </div>

        <div class="plan-actions">
          <button 
            *ngIf="!isCurrentPlan(plan)"
            (click)="switchPlan(plan)"
            [disabled]="switching"
            class="switch-button"
            [class.upgrade-button]="isUpgrade(plan)"
            [class.downgrade-button]="isDowngrade(plan)">
            <span *ngIf="switching" class="material-icons spinning">sync</span>
            <span *ngIf="!switching">
              {{ isUpgrade(plan) ? 'Upgrade' : 'Switch' }} to {{ plan.name }}
            </span>
          </button>
          
          <button 
            *ngIf="isCurrentPlan(plan)"
            disabled
            class="current-plan-button">
            <span class="material-icons">check_circle</span>
            Current Plan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Confirmation Modal -->
  <div *ngIf="showPaymentModal && switchPreview" class="modal-overlay" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Upgrade</h2>
        <button class="modal-close" (click)="closePaymentModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="upgrade-summary">
          <div class="plan-comparison">
            <div class="from-plan">
              <span class="label">Current Plan</span>
              <span class="plan-name">{{ switchPreview.preview.current_plan.name }}</span>
              <span class="plan-cost">₦{{ formatNumber(switchPreview.billing_info.old_cost) }}/{{ billingCycle }}</span>
            </div>
            <div class="arrow">
              <span class="material-icons">arrow_forward</span>
            </div>
            <div class="to-plan">
              <span class="label">New Plan</span>
              <span class="plan-name">{{ switchPreview.preview.new_plan.name }}</span>
              <span class="plan-cost">₦{{ formatNumber(switchPreview.billing_info.new_cost) }}/{{ billingCycle }}</span>
            </div>
          </div>

          <div class="payment-details">
            <div class="detail-row">
              <span class="label">Prorated Amount Due Now</span>
              <span class="amount highlight">₦{{ formatNumber(switchPreview.billing_info.prorated_amount) }}</span>
            </div>
            <p class="note">
              This is the difference in cost for the remaining days in your current billing period.
              Your next billing cycle will be charged at the new rate.
            </p>
          </div>
        </div>

        <div *ngIf="error" class="modal-error">
          <span class="material-icons">error</span>
          {{ error }}
        </div>
      </div>

      <div class="modal-footer">
        <button
          class="cancel-button"
          (click)="closePaymentModal()"
          [disabled]="processingPayment">
          Cancel
        </button>
        <button
          class="pay-button"
          (click)="initiatePayment()"
          [disabled]="processingPayment">
          <span *ngIf="processingPayment" class="material-icons spinning">sync</span>
          <span *ngIf="!processingPayment">
            Pay ₦{{ formatNumber(switchPreview.billing_info.prorated_amount) }} & Upgrade
          </span>
        </button>
      </div>
    </div>
  </div>
</div>