<!-- Dashboard Header -->
<div class="dashboard-header">
  <div class="header-content">
    <div class="header-info">
      <img src="/logo.png" alt="ChatCraft" class="logo">
      <div class="title-section">
        <h1>Dashboard</h1>
        <p class="subtitle">Overview of your ChatCraft account</p>
      </div>
    </div>
    <button class="refresh-btn" (click)="refresh()" [disabled]="loading" title="Refresh Dashboard">
      <span class="material-icons refresh-icon" [class.spinning]="loading">refresh</span>
    </button>
  </div>
</div>

<!-- Plan Mismatch Warning Banner -->
<div *ngIf="showMismatchWarning && planMismatch?.detected" class="warning-banner">
  <div class="warning-content">
    <span class="material-icons warning-icon">warning</span>
    <div class="warning-message">
      <strong>Plan Data Inconsistency Detected</strong>
      <p>Your account data shows conflicting plan information. We're displaying your active subscription plan. Please contact support if this appears incorrect.</p>
    </div>
    <button class="dismiss-btn" (click)="dismissMismatchWarning()" title="Dismiss warning">
      <span class="material-icons">close</span>
    </button>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Loading dashboard data...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
  <div class="error-icon">⚠️</div>
  <h3>Unable to load dashboard</h3>
  <p>{{ error }}</p>
  <button class="retry-btn" (click)="refresh()">Try Again</button>
</div>

<!-- Dashboard Content -->
<div *ngIf="!loading && !error" class="dashboard-content">
  <!-- Organization Info Card -->
  <div class="info-card organization-card" *ngIf="dashboardData && dashboardData.tenant">
    <div class="card-header">
      <h2><span class="material-icons">business</span> Organization Information</h2>
    </div>
    <div class="card-body">
      <div class="org-info">
        <div class="org-details">
          <h3>{{ dashboardData.tenant.name }}</h3>
          <p class="domain" *ngIf="dashboardData.tenant.domain">{{ dashboardData.tenant.domain }}</p>
          <p class="website" *ngIf="dashboardData.tenant.website_url">
            <a [href]="dashboardData.tenant.website_url" target="_blank">{{ dashboardData.tenant.website_url }}</a>
          </p>
        </div>
        <div class="subscription-info">
          <span class="subscription-badge" [ngClass]="getSubscriptionBadgeClass(getCurrentPlanDisplay())">
            {{ getCurrentPlanDisplay() }}
          </span>
          <div class="status-info">
            <span class="status" [class.active]="dashboardData.tenant.isActive" [class.inactive]="!dashboardData.tenant.isActive">
              <span *ngIf="dashboardData.tenant.isActive" class="material-icons status-icon">check_circle</span>
              <span *ngIf="!dashboardData.tenant.isActive" class="material-icons status-icon">cancel</span>
              {{ dashboardData.tenant.isActive ? 'Active' : 'Inactive' }}
            </span>
            <span class="created-date">
              Member since {{ formatDate(dashboardData.tenant.createdAt) }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Plan Card -->
  <div class="info-card plan-card">
    <div class="card-header">
      <h2><span class="material-icons">assignment</span> Current Plan</h2>
      <button class="manage-plans-btn" (click)="navigateToPlans()" title="Manage Plans">
        <span class="material-icons">settings</span>
        Manage Plans
      </button>
    </div>
    <div class="card-body">
      <div class="plan-info" *ngIf="dashboardData?.currentPlan; else noPlan">
        <div class="plan-details">
          <h3>{{ getPlanDisplayName(dashboardData?.currentPlan) }}</h3>
          <p class="plan-description" *ngIf="dashboardData?.currentPlan?.description">
            {{ dashboardData?.currentPlan?.description }}
          </p>
          <div class="plan-limits">
            <h4>Plan Limits:</h4>
            <p>{{ getPlanLimitsText(dashboardData?.currentPlan) }}</p>
          </div>
          <div class="plan-pricing" *ngIf="dashboardData?.currentPlan?.monthly_plan_cost">
            <span class="price-monthly">₦{{ formatNumber(dashboardData!.currentPlan!.monthly_plan_cost!) }}/month</span>
            <span class="price-yearly" *ngIf="dashboardData?.currentPlan?.yearly_plan_cost">
              or ₦{{ formatNumber(dashboardData!.currentPlan!.yearly_plan_cost!) }}/year
            </span>
          </div>

          <!-- Subscription Expiry Information -->
          <div class="subscription-expiry" *ngIf="currentSubscription && currentSubscription.current_period_end">
            <div class="expiry-badge" [ngClass]="{
              'expiry-warning': isExpiringSoon(),
              'expiry-danger': hasExpired(),
              'expiry-normal': !isExpiringSoon() && !hasExpired()
            }">
              <span class="material-icons">
                {{ hasExpired() ? 'error' : isExpiringSoon() ? 'warning' : 'schedule' }}
              </span>
              <div class="expiry-text">
                <span class="expiry-label">
                  {{ hasExpired() ? 'Expired' : currentSubscription.cancel_at_period_end ? 'Cancels' : 'Renews' }}
                </span>
                <span class="expiry-date">{{ formatExpiryDate(currentSubscription.current_period_end) }}</span>
                <span class="expiry-countdown" *ngIf="!hasExpired()">
                  {{ getDaysUntilExpiry() }} {{ getDaysUntilExpiry() === 1 ? 'day' : 'days' }} remaining
                </span>
              </div>
            </div>
          </div>

          <div class="plan-actions">
            <button class="upgrade-btn" (click)="navigateToPlans()">
              <span class="material-icons">upgrade</span>
              View All Plans
            </button>
          </div>
        </div>
      </div>
      <ng-template #noPlan>
        <div class="no-plan">
          <p>No plan currently selected. Contact support to set up your subscription.</p>
          <button class="select-plan-btn" (click)="navigateToPlans()">
            <span class="material-icons">add_circle</span>
            Select a Plan
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- User Information Card -->
  <div class="info-card user-card" *ngIf="currentUser">
    <div class="card-header">
      <h2><span class="material-icons">person</span> User Information</h2>
    </div>
    <div class="card-body">
      <div class="user-info">
        <div class="user-avatar">
          <span class="avatar-text">{{ (currentUser.full_name || currentUser.email)?.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="user-details">
          <h3>{{ currentUser.full_name || currentUser.email }}</h3>
          <p class="email" *ngIf="currentUser.email">{{ currentUser.email }}</p>
          <p class="tenant-id">Tenant ID: {{ currentUser.tenant_id }}</p>
          <p class="role">Role: {{ currentUser.role || 'User' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Summary -->
  <div class="info-card activity-card">
    <div class="card-header">
      <h2><span class="material-icons">analytics</span> Activity Summary</h2>
    </div>
    <div class="card-body">
      <div class="activity-items">
        <div class="activity-item">
          <div class="activity-label">Last Activity</div>
          <div class="activity-value">{{ formatDate(dashboardData?.lastActivityDate || '') }}</div>
        </div>
        <div class="activity-item">
          <div class="activity-label">Storage Used</div>
          <div class="activity-value">{{ dashboardData?.storageUsed || 'N/A' }}</div>
        </div>
        <div class="activity-item">
          <div class="activity-label">Account Status</div>
          <div class="activity-value">
            <span class="status-badge active">Active</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Usage Statistics Card -->
  <div class="info-card usage-card" *ngIf="dashboardData?.currentUsage">
    <div class="card-header">
      <h2><span class="material-icons">data_usage</span> Usage Statistics</h2>
      <span class="usage-period" *ngIf="getBillingPeriod()">
        {{ getBillingPeriod() }}
      </span>
    </div>
    <div class="card-body">
      <div class="usage-items" *ngIf="dashboardData?.currentUsage">
        <!-- Documents Usage -->
        <div class="usage-item" *ngIf="dashboardData?.currentUsage?.documents">
          <div class="usage-header">
            <span class="usage-label">
              <span class="material-icons">description</span>
              Documents
            </span>
            <span class="usage-count">
              {{ formatNumber(dashboardData!.currentUsage!.documents.used) }} / {{ formatNumber(dashboardData!.currentUsage!.documents.limit) }}
            </span>
          </div>
          <div class="progress-bar" [attr.data-percentage]="dashboardData?.currentUsage?.documents?.percentage">
            <div class="progress-fill"
                 [style.width.%]="dashboardData?.currentUsage?.documents?.percentage"
                 [class.warning]="(dashboardData?.currentUsage?.documents?.percentage || 0) >= 80"
                 [class.danger]="(dashboardData?.currentUsage?.documents?.percentage || 0) >= 100">
            </div>
          </div>
          <div class="usage-info">
            <span class="percentage">{{ dashboardData?.currentUsage?.documents?.percentage }}% used</span>
            <span class="remaining">{{ formatNumber(dashboardData!.currentUsage!.documents.remaining) }} remaining</span>
          </div>
        </div>

        <!-- Websites Usage -->
        <div class="usage-item" *ngIf="dashboardData?.currentUsage?.websites">
          <div class="usage-header">
            <span class="usage-label">
              <span class="material-icons">web</span>
              Websites
            </span>
            <span class="usage-count">
              {{ formatNumber(dashboardData!.currentUsage!.websites.used) }} / {{ formatNumber(dashboardData!.currentUsage!.websites.limit) }}
            </span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill"
                 [style.width.%]="dashboardData?.currentUsage?.websites?.percentage"
                 [class.warning]="(dashboardData?.currentUsage?.websites?.percentage || 0) >= 80"
                 [class.danger]="(dashboardData?.currentUsage?.websites?.percentage || 0) >= 100">
            </div>
          </div>
          <div class="usage-info">
            <span class="percentage">{{ dashboardData?.currentUsage?.websites?.percentage }}% used</span>
            <span class="remaining">{{ formatNumber(dashboardData!.currentUsage!.websites.remaining) }} remaining</span>
          </div>
        </div>

        <!-- Daily Chats Usage -->
        <div class="usage-item" *ngIf="dashboardData?.currentUsage?.daily_chats">
          <div class="usage-header">
            <span class="usage-label">
              <span class="material-icons">chat</span>
              Daily Chats
            </span>
            <span class="usage-count">
              {{ formatNumber(dashboardData!.currentUsage!.daily_chats.used) }} / {{ formatNumber(dashboardData!.currentUsage!.daily_chats.limit) }}
            </span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill"
                 [style.width.%]="dashboardData?.currentUsage?.daily_chats?.percentage"
                 [class.warning]="(dashboardData?.currentUsage?.daily_chats?.percentage || 0) >= 80"
                 [class.danger]="(dashboardData?.currentUsage?.daily_chats?.percentage || 0) >= 100">
            </div>
          </div>
          <div class="usage-info">
            <span class="percentage">{{ dashboardData?.currentUsage?.daily_chats?.percentage }}% used</span>
            <span class="remaining" *ngIf="dashboardData?.currentUsage?.daily_chats?.resets_at">
              Resets {{ getResetTime(dashboardData?.currentUsage?.daily_chats?.resets_at!) }}
            </span>
          </div>
        </div>

        <!-- Monthly Chats Usage -->
        <div class="usage-item" *ngIf="dashboardData?.currentUsage?.monthly_chats">
          <div class="usage-header">
            <span class="usage-label">
              <span class="material-icons">smart_toy</span>
              Monthly Chats
            </span>
            <span class="usage-count">
              {{ formatNumber(dashboardData!.currentUsage!.monthly_chats.used) }} / {{ formatNumber(dashboardData!.currentUsage!.monthly_chats.limit) }}
            </span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill"
                 [style.width.%]="dashboardData?.currentUsage?.monthly_chats?.percentage"
                 [class.warning]="(dashboardData?.currentUsage?.monthly_chats?.percentage || 0) >= 80"
                 [class.danger]="(dashboardData?.currentUsage?.monthly_chats?.percentage || 0) >= 100">
            </div>
          </div>
          <div class="usage-info">
            <span class="percentage">{{ dashboardData?.currentUsage?.monthly_chats?.percentage }}% used</span>
            <span class="remaining" *ngIf="dashboardData?.currentUsage?.monthly_chats?.resets_at">
              Resets {{ getResetTime(dashboardData?.currentUsage?.monthly_chats?.resets_at!) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Usage Warnings -->
      <div class="usage-warnings" *ngIf="getUsageWarnings().length > 0">
        <div class="warning-message" *ngFor="let warning of getUsageWarnings()">
          <span class="material-icons">warning</span>
          {{ warning }}
        </div>
      </div>
    </div>
  </div>

  <!-- Widget Downloads -->
  <div class="info-card widget-card">
    <div class="card-header">
      <h2><span class="material-icons">smart_toy</span> Chat Widget</h2>
    </div>
    <div class="card-body">
      <div class="widget-info" *ngIf="dashboardData?.widgetInfo">
        <p>Embed a custom AI chat widget on your website to provide instant customer support.</p>

        <div class="widget-actions">
          <div class="widget-downloads">
            <h4>Download Widget Files:</h4>
            <div class="download-buttons">
              <button class="download-btn" (click)="downloadWidgetFile('javascript')" title="Download Widget JavaScript file">
                <span class="material-icons btn-icon">code</span>
                <span class="btn-text">Download Widget JavaScript</span>
              </button>
            </div>
          </div>

          <div class="widget-utilities">
            <h4>Widget Tools:</h4>
            <div class="utility-buttons">
              <button class="utility-btn primary" (click)="viewIntegrationGuide()" title="View integration instructions">
                <span class="material-icons btn-icon">menu_book</span>
                <span class="btn-text">Integration Guide</span>
              </button>
              <button class="utility-btn secondary" (click)="previewWidget()" title="Preview the widget">
                <span class="material-icons btn-icon">visibility</span>
                <span class="btn-text">Preview Widget</span>
              </button>
              <button class="utility-btn tertiary" (click)="generateWidget()" title="Regenerate widget files">
                <span class="material-icons btn-icon">refresh</span>
                <span class="btn-text">Regenerate</span>
              </button>
            </div>
          </div>
        </div>

        <div class="widget-status" *ngIf="dashboardData?.widgetInfo">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span class="status-value active">{{ dashboardData?.widgetInfo?.widget_status }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">API Key:</span>
            <span class="status-value" [class.configured]="dashboardData?.widgetInfo?.api_key_configured" [class.missing]="!dashboardData?.widgetInfo?.api_key_configured">
              <span *ngIf="dashboardData?.widgetInfo?.api_key_configured" class="material-icons status-icon">check_circle</span>
              <span *ngIf="!dashboardData?.widgetInfo?.api_key_configured" class="material-icons status-icon">cancel</span>
              {{ dashboardData?.widgetInfo?.api_key_configured ? 'Configured' : 'Missing' }}
            </span>
          </div>
        </div>
      </div>
      <div *ngIf="!dashboardData?.widgetInfo" class="widget-loading">
        <p>Loading widget information...</p>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="info-card actions-card">
    <div class="card-header">
      <h2><span class="material-icons">bolt</span> Quick Actions</h2>
    </div>
    <div class="card-body">
      <div class="quick-actions">
        <a routerLink="/documents" class="action-btn primary">
          <span class="material-icons action-icon">description</span>
          <span class="action-text">View Documents</span>
        </a>
        <a routerLink="/upload" class="action-btn secondary">
          <span class="material-icons action-icon">upload</span>
          <span class="action-text">Upload Document</span>
        </a>
        <a routerLink="/websites" class="action-btn tertiary">
          <span class="material-icons action-icon">web</span>
          <span class="action-text">Manage Websites</span>
        </a>
      </div>
    </div>
  </div>
</div>
